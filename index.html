<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>CR Tool</title>
		<link href="assets/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet">
		<link href="assets/custom.css" rel="stylesheet">
	</head>
	<body>
		<div class="container-fluid">
			<div class="row" id="header">
				<h2 class="text-center">Computed Radiography Tool</h2>
				<hr>
			</div>
			<div class="row">
				<div class="col-xs-12 text-center">
					<form class="form-horizontal">
						<div class="form-group">
							<input type="file" id="selectFile">
							Drop here your file
						</div>
					</form>
				</div>
				
			</div>
			<div id="loadProgress">Image Load Progress:</div>
			<div class="row">
				<div class="col-xs-12 col-md-4 col-lg-4 ">
					asasd
				</div>
				<div class="col-xs-12 col-md-8 col-lg-8">
					<div style="width:800px;height:600px;position:relative;color: white;display:inline-block;border-style:solid;border-color:black;"
						oncontextmenu="return false"
						class='disable-selection noIbar'
						unselectable='on'
						onselectstart='return false;'
						onmousedown='return false;'>
						<div id="dicomImage"
							style="width:800px;height:600px;top:0px;left:0px; position:absolute">
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<!-- jquery - currently a dependency and thus required for using cornerstoneWADOImageLoader -->
	<script src="assets/jquery-2.2.0.min.js"></script>
	<!-- Bootstrap -->
	<script src="assets/bootstrap-3.3.6/js/bootstrap.min.js"></script>
	<!-- include the cornerstone library -->
	<script src="assets/cornerstone/cornerstone.min.js"></script>
	<SCRIPT src="assets/cornerstone/cornerstoneMath.js"></SCRIPT>
	<SCRIPT src="assets/cornerstone/cornerstoneTools.js"></SCRIPT>
	<!-- include the dicomParser library as the WADO image loader depends on it -->
	<script src="assets/cornerstone/dicomParser.min.js"></script>
	<!-- jpeg 2000 codec -->
	<script src="assets/cornerstone/jpx.min.js"></script>
	<!-- include the cornerstoneWADOImageLoader library -->
	<script src="assets/cornerstone/cornerstoneWADOImageLoader.js"></script>

<script>

    cornerstoneWADOImageLoader.configure({
        beforeSend: function(xhr) {
            // Add custom headers here (e.g. auth tokens)
            //xhr.setRequestHeader('x-auth-token', 'my auth token');
        }
    });

    var loaded = false;

    function loadAndViewImage(imageId) {
        var element = $('#dicomImage').get(0);
        //try {
        cornerstone.loadImage(imageId).then(function(image) {
            console.log(image);
            console.log("asdasdasd");
            var viewport = cornerstone.getDefaultViewportForImage(element, image);
            $('#toggleModalityLUT').attr("checked",viewport.modalityLUT !== undefined);
            $('#toggleVOILUT').attr("checked",viewport.voiLUT !== undefined);
            cornerstone.displayImage(element, image, viewport);
            if(loaded === false) {
                cornerstoneTools.mouseInput.enable(element);
                cornerstoneTools.mouseWheelInput.enable(element);
                cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
                cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
                cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
                cornerstoneTools.zoomWheel.activate(element); // zoom is the default tool for middle mouse wheel
                loaded = true;
            }
        }, function(err) {
            alert(err);
        });
        /*}
         catch(err) {
         alert(err);
         }*/
    }

    $(cornerstone).bind('CornerstoneImageLoadProgress', function(eventData) {
        $('#loadProgress').text('Image Load Progress: ' + eventData.percentComplete + "%");
    });

    $(document).ready(function() {

        var element = $('#dicomImage').get(0);
        cornerstone.enable(element);

        $('#selectFile').on('change', function(e) {
            // Add the file to the cornerstoneFileImageLoader and get unique
            // number for that file
            var file = e.target.files[0];
            var imageId = cornerstoneWADOImageLoader.fileManager.add(file);
            loadAndViewImage(imageId);
        });

        $('#toggleModalityLUT').on('click', function() {
            var applyModalityLUT = $('#toggleModalityLUT').is(":checked");
            console.log('applyModalityLUT=', applyModalityLUT);
            var image = cornerstone.getImage(element);
            var viewport = cornerstone.getViewport(element);
            if(applyModalityLUT) {
                viewport.modalityLUT = image.modalityLUT;
            } else {
                viewport.modalityLUT = undefined;
            }
            cornerstone.setViewport(element, viewport);
        });

        $('#toggleVOILUT').on('click', function() {
            var applyVOILUT = $('#toggleVOILUT').is(":checked");
            console.log('applyVOILUT=', applyVOILUT);
            var image = cornerstone.getImage(element);
            var viewport = cornerstone.getViewport(element);
            if(applyVOILUT) {
                viewport.voiLUT = image.voiLUT;
            } else {
                viewport.voiLUT = undefined;
            }
            cornerstone.setViewport(element, viewport);
        });


    });

</script>
</html>